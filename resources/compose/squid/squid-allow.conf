# listen port
http_port 3128

# local networks
acl localnet src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16

# allowed destination domains (list as before)
acl ALLOWED_DOM dstdomain presalesemeaprod.um.int-aws-de.webmethods.io
acl ALLOWED_DOM dstdomain presalesemeaprod.int-aws-de.webmethods.io
acl ALLOWED_DOM dstdomain dev5312404.a-fra-c1.int.ipaas.automation.ibm.com 
acl ALLOWED_DOM dstdomain dev5312404.um.a-fra-c1.int.ipaas.automation.ibm.com
acl ALLOWED_DOM dstdomain dev6056135.a-fra-c1.int.ipaas.automation.ibm.com 
acl ALLOWED_DOM dstdomain dev6056135.um.a-fra-c1.int.ipaas.automation.ibm.com
acl ALLOWED_DOM dstdomain test601639.a-fra-c1.int.ipaas.automation.ibm.com 
acl ALLOWED_DOM dstdomain test601639.um.a-fra-c1.int.ipaas.automation.ibm.com
acl ALLOWED_DOM dstdomain console-ibm-prod.verify.ibm.com
acl ALLOWED_DOM dstdomain idaas-eu01b.ice.ibmcloud.com
acl ALLOWED_DOM dstdomain login.ibm.com
acl ALLOWED_DOM dstdomain login.w3.ibm.com
acl ALLOWED_DOM dstdomain github.com

# block plain WebSocket upgrade header (ws://)
# match requests that include "Upgrade: websocket"
acl websocket_upgrade req_header Upgrade -i websocket
http_access deny websocket_upgrade

# CONNECT handling:
# define CONNECT method
acl CONNECT method CONNECT

# allow localhost management
http_access allow localhost

# Allow normal HTTP(S) from localnet to allowed domains
http_access allow localnet ALLOWED_DOM

# Allow CONNECT (tunnel) only to allowed domains from localnet (permits wss to ALLOWED_DOM)
http_access allow localnet CONNECT ALLOWED_DOM

# Deny any CONNECT attempts from localnet to other destinations (blocks wss to non-allowed)
http_access deny localnet CONNECT

# Deny everything else
http_access deny all

