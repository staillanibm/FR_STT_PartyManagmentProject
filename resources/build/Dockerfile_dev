FROM iwhicr.azurecr.io/webmethods-edge-runtime:11.2.3

# A staged build is required if you want to protect these two secrets. Docker secrets could also be used.
ARG WPM_TOKEN
ARG GIT_TOKEN

# Copy packages
# In the dev image we only copy the adapters and connectors (those which are fetched from Github using ssh)
# The Git packages directly imported in the UI are fetched by the Edge Runtime using https 
# JDBC drivers are provided in the UI, upon creation of the connections
RUN wpm install -ws https://packages.webmethods.io -wr licensed -j $WPM_TOKEN -d /opt/softwareag/IntegrationServer WmJDBCAdapter:latest
RUN wpm install -ws https://packages.webmethods.io -wr licensed -j $WPM_TOKEN -d /opt/softwareag/IntegrationServer WmKafkaAdapter:latest
RUN wpm install -ws https://packages.webmethods.io -wr supported -j $WPM_TOKEN -d /opt/softwareag/IntegrationServer WmAmazonS3Provider:latest

USER 0

# Set authorizations for OpenShift
RUN chgrp -R 0 \
      /opt/softwareag/IntegrationServer/packages/WmJDBCAdapter \
      /opt/softwareag/IntegrationServer/packages/WmAmazonS3Provider \
      /opt/softwareag/IntegrationServer/packages/WmKafkaAdapter \
      && \
    chmod -R g=u \
      /opt/softwareag/IntegrationServer/packages/WmJDBCAdapter \
      /opt/softwareag/IntegrationServer/packages/WmAmazonS3Provider \
      /opt/softwareag/IntegrationServer/packages/WmKafkaAdapter 

USER 1724
